{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-4">Admin Panel</h1>
            <p class="text-muted">Manage your cocktail application</p>
            <hr>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Statistics Section -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Users</h5>
                    <p class="display-4">{{ stats.total_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Cocktails</h5>
                    <p class="display-4">{{ stats.total_cocktails }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">API Cocktails</h5>
                    <p class="display-4">{{ stats.total_api_cocktails }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">User Cocktails</h5>
                    <p class="display-4">{{ stats.total_user_cocktails }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Management Section -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">User Management</h3>
                </div>
                <div class="card-body">
                    {% if users %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                        <tr>
                                            <td>{{ user.id }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>
                                                {% if user.is_admin %}
                                                    <span class="badge bg-danger">Admin</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">User</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if user.id != session.user_id %}
                                                    {% if user.is_permanently_banned %}
                                                        <span class="badge bg-dark">Permanently Banned</span>
                                                        <form method="POST" action="{{ url_for('remove_user_ban', user_id=user.id) }}" style="display: inline;">
                                                            <button type="submit" class="btn btn-sm btn-info" onclick="return confirm('Remove permanent ban for {{ user.username }}?')">Remove Ban</button>
                                                        </form>
                                                    {% elif user.ban_until and user.ban_until > now %}
                                                        <span class="badge bg-warning text-dark">Banned until {{ user.ban_until.strftime('%Y-%m-%d') }}</span>
                                                        <form method="POST" action="{{ url_for('remove_user_ban', user_id=user.id) }}" style="display: inline;">
                                                            <button type="submit" class="btn btn-sm btn-info" onclick="return confirm('Remove ban for {{ user.username }}?')">Remove Ban</button>
                                                        </form>
                                                    {% else %}
                                                        {% if not user.is_admin %}
                                                            <form method="POST" action="{{ url_for('promote_user', user_id=user.id) }}" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Promote {{ user.username }} to admin?')">Promote</button>
                                                            </form>
                                                            <form method="POST" action="{{ url_for('ban_user', user_id=user.id) }}" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Ban {{ user.username }} for one year?')">Ban 1yr</button>
                                                            </form>
                                                            <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete {{ user.username }}? This cannot be undone.')">Delete</button>
                                                            </form>
                                                        {% else %}
                                                            <form method="POST" action="{{ url_for('demote_user', user_id=user.id) }}" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Demote {{ user.username }} from admin?')">Demote</button>
                                                            </form>
                                                            <form method="POST" action="{{ url_for('ban_user_permanently', user_id=user.id) }}" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Permanently ban {{ user.username }}? They cannot return.')">Ban Permanently</button>
                                                            </form>
                                                        {% endif %}
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-info">You</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No users found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Info Section -->
    <div class="row mt-5">
        <div class="col-md-12">
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">Security Information</h4>
                <p>
                    <strong>Admin Panel Security:</strong> This admin panel is protected by an admin password key stored in your .env file. 
                    Only users with the correct password key can access this panel and be granted admin privileges.
                </p>
                <hr>
                <p class="mb-0">
                    <strong>Important:</strong> The .env file is not committed to GitHub. This ensures your admin password key remains private and secure.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="row mt-5">
        <div class="col-md-12">
            <a href="{{ url_for('homepage') }}" class="btn btn-primary">Back to Home</a>
            <a href="{{ url_for('admin_messages') }}" class="btn btn-info">View User Messages</a>
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .display-4 {
        font-weight: bold;
    }
</style>
{% endblock %}
